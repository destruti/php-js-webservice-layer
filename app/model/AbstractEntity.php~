<?php

/**
 * MÃ¡quina do Bem
 * AniversÃ¡rio do Bem
 * CTO, Development and Architeture
 * By Eduardo Destruti
 */

ini_set('display_errors', 1);

//error_reporting(0);
//ini_set('display_errors','Off');

//var_dump($_SERVER);die;

if (getenv('APPLICATION_ENV') == 'live') {

    if(substr($_SERVER['HTTP_HOST'],0,4) == 'www.'){
        $cleanUrl = substr($_SERVER['HTTP_HOST'],4,strlen($_SERVER['HTTP_HOST']));
        $newUrl = $_SERVER['REQUEST_SCHEME'].'://'.$cleanUrl.@$_SERVER['REDIRECT_URL'];
        header('Location: '.$newUrl);
        exit;
    }

    if ( ($_SERVER['REQUEST_SCHEME'] == 'http') && ($_SERVER['HTTP_HOST'] == 'aniversariodobem.com')) {
        $newUrl = 'https://aniversariodobem.com';
        if (isset($_SERVER['REDIRECT_URL'])) { $newUrl = $newUrl . $_SERVER['REDIRECT_URL']; };
        header('Location: '.$newUrl);
        exit;
    }

    if ( ($_SERVER['REQUEST_SCHEME'] == 'http') && ($_SERVER['HTTP_HOST'] == 'maquinadobem.com')) {
        $newUrl = 'https://maquinadobem.com';
        if (isset($_SERVER['REDIRECT_URL'])) { $newUrl = $newUrl . $_SERVER['REDIRECT_URL']; };
        header('Location: '.$newUrl);
        exit;
    }

    if ( ($_SERVER['REQUEST_SCHEME'] == 'http') && ($_SERVER['HTTP_HOST'] == 'presentedobem.org')) {
        $newUrl = 'https://presentedobem.org';
        if (isset($_SERVER['REDIRECT_URL'])) { $newUrl = $newUrl . $_SERVER['REDIRECT_URL']; };
        header('Location: '.$newUrl);
        exit;
    }

    if ( ($_SERVER['REQUEST_SCHEME'] == 'http') && ($_SERVER['HTTP_HOST'] == 'presentedobem.org.br')) {
        $newUrl = 'https://presentedobem.org';
        if (isset($_SERVER['REDIRECT_URL'])) { $newUrl = $newUrl . $_SERVER['REDIRECT_URL']; };
        header('Location: '.$newUrl);
        exit;
    }

    if ( ($_SERVER['REQUEST_SCHEME'] == 'http') && ($_SERVER['HTTP_HOST'] == 'presentedobem.com.br')) {
        $newUrl = 'https://presentedobem.org';
        if (isset($_SERVER['REDIRECT_URL'])) { $newUrl = $newUrl . $_SERVER['REDIRECT_URL']; };
        header('Location: '.$newUrl);
        exit;
    }

}

require 'libs/mail/Mail.php';

require 'libs/sociallogin/facebook/facebook.php';
require 'libs/sociallogin/twitter/twitteroauth.php';

require "libs/moip/lib/Moip.php";
require "libs/moip/lib/MoipClient.php";
require "libs/moip/lib/MoipStatus.php";

require "libs/mobile/Mobile_Detect.php";

require "libs/PushBullet/PushBullet.class.php";
require "libs/whatsapp/src/whatsprot.class.php";

require "libs/mpdf/mpdf.php";

try {

    /**
     * The FactoryDefault Dependency Injector automatically register the right services providing a full stack framework
     */
    $di = new \Phalcon\DI\FactoryDefault();

    $loader = new \Phalcon\Loader();

    $loader->registerNamespaces(array(
        'Meg\Libs'   => __DIR__.'/../common/library/',
        'Meg\Charts' => __DIR__.'/../common/charts/',
    ));

    $loader->register();

    /**
     * Layout Definition
     */
    $di->set('layout', function() use ($di) {

        // $admin = 0;
        // $correct = 0;
        // var_dump($_SERVER['HTTP_HOST']);die;

        if ($_SERVER['HTTP_HOST'] == 'aniversariodobem.com') return 'aniversariodobem';
        if ($_SERVER['HTTP_HOST'] == 'dashboard.aniversariodobem.com') return 'dashboardaniversariodobem';

        if ($_SERVER['HTTP_HOST'] == 'niver.me') return 'aniversariodobem';
        if ($_SERVER['HTTP_HOST'] == 'giftforhope.com') return 'aniversariodobem';

        if ($_SERVER['HTTP_HOST'] == 'instrumento.maquinadobem.com') return 'instrumento';
        if ($_SERVER['HTTP_HOST'] == 'admin.maquinadobem.com') return 'adminmaquinadobem';
        if ($_SERVER['HTTP_HOST'] == 'maquinadobem.com') return 'maquinadobem';

        if ($_SERVER['HTTP_HOST'] == 'presentedobem.com.br') return 'visaomundial';
        if ($_SERVER['HTTP_HOST'] == 'presentedobem.org.br') return 'visaomundial';
        if ($_SERVER['HTTP_HOST'] == 'presentedobem.org') return 'visaomundial';

        //////////////// DEV //////////////////

        if ($_SERVER['HTTP_HOST'] == 'aniversariodobem.dev') return 'aniversariodobem';
        if ($_SERVER['HTTP_HOST'] == 'instrumento.maquinadobem.dev') return 'instrumento';
        if ($_SERVER['HTTP_HOST'] == 'dashboard.aniversariodobem.dev') return 'dashboardaniversariodobem';
        if ($_SERVER['HTTP_HOST'] == 'presentedobem.dev') return 'visaomundial';
        if ($_SERVER['HTTP_HOST'] == 'admin.maquinadobem.dev') return 'adminmaquinadobem';
        if ($_SERVER['HTTP_HOST'] == 'maquinadobem.dev') return 'maquinadobem';

        return 'aniversariodobem';

    }, true);

    /**
     * Registering a router specific for any website
     */
    $di->set('router', require __DIR__.'/../common/'.$di->get("layout").'/route.php');

    /**
     * The URL component is used to generate all kind of urls in the application
     */
    $di->set('url', function() {
        $url = new \Phalcon\Mvc\Url();
        $url->setBaseUri('/');
        return $url;
    });

    /**
     * Set up crypt Cookies
     */
//    $di->set('cookies', function() {
//        $cookies = new Phalcon\Http\Response\Cookies();
//        $cookies->setEncryption(false);
//        return $cookies;
//    });


    /**
     * Set up the flash service
     */
    $di->set('flash', function() {
        return new \Phalcon\Flash\Direct();
    });

    /**
     * Start the session the first time some component request the session service
     */
    $di->set('session', function() {
        $session = new Phalcon\Session\Adapter\Files();
        $session->start();
        return $session;
    });

    //Set the views cache service
    $di->set('viewCache', function(){

        //Cache data for one day by default
        $frontCache = new Phalcon\Cache\Frontend\Output(array(
            "lifetime" => 86400
        ));

        //File backend settings
        $cache = new Phalcon\Cache\Backend\File($frontCache, array(
            "cacheDir" => __DIR__."/../var/cache/",
        ));

        return $cache;
    });

    /**
     * Main logger file
     */
    $di->set('logger', function() {
        return new \Phalcon\Logger\Adapter\File(__DIR__.'/../var/logs/'.date('Ymd').'.log');
    }, true);

    /**
     * Handle the request
     */
    $application = new \Phalcon\Mvc\Application();

    $application->setDI($di);

    /**
     * Register application modules
     */
    $application->registerModules(require __DIR__.'/../common/'.$di->get("layout").'/modules.php');

    echo $application->handle()->getContent();

}
catch (Phalcon\Exception $e) {

    sleep(5);
    error_log(date('Y.d.m h:i:s').' > '.var_export('Error PHP 1 -> ' . $e->getMessage().' in '. $e->getFile(). ' line ' . $e->getLine(), true).PHP_EOL, 3, "/tmp/errors.log");
//    error_log(date('Y.d.m h:i:s').' > '.var_export($e, true).PHP_EOL, 3, "/tmp/errors.log");
    // echo $e->getMessage();
    // $response = new \Phalcon\Http\Response();
    // $response->redirect("/manutencao.php", true);
    // $response->send();

}
catch (PDOException $e){

    sleep(5);
    error_log(date('Y.d.m h:i:s').' > '.var_export('Error PHP 2 -> ' . $e->getMessage().' in '. $e->getFile(). ' line ' . $e->getLine(), true).PHP_EOL, 3, "/tmp/errors.log");
    // $response = new \Phalcon\Http\Response();
    // $response->redirect("/manutencao.php", true);
    // $response->send();
}